name: Deploy Functions to Production

on:
  pull_request:
    branches: [ main ]
    types: [ closed ]
    paths:
      - 'UsersFunction/**'
      - 'AnimalsFunction/**'
      - 'PlugginsRandomFunctionOne/**'

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      users-function: ${{ steps.changes.outputs.users-function }}
      animals-function: ${{ steps.changes.outputs.animals-function }}
      plugins-function: ${{ steps.changes.outputs.plugins-function }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            users-function:
              - 'UsersFunction/**'
            animals-function:
              - 'AnimalsFunction/**'
            plugins-function:
              - 'PlugginsRandomFunctionOne/**'

  deploy-functions:
    needs: detect-changes
    if: github.event.pull_request.merged == true && (needs.detect-changes.outputs.users-function == 'true' || needs.detect-changes.outputs.animals-function == 'true' || needs.detect-changes.outputs.plugins-function == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        function-config: [
          { name: 'UsersFunction', path: 'UsersFunction', changed: '${{ needs.detect-changes.outputs.users-function }}' },
          { name: 'AnimalsFunction', path: 'AnimalsFunction', changed: '${{ needs.detect-changes.outputs.animals-function }}' },
          { name: 'PlugginsRandomFunctionOne', path: 'PlugginsRandomFunctionOne', changed: '${{ needs.detect-changes.outputs.plugins-function }}' }
        ]
    steps:
      - name: Checkout code
        if: matrix.function-config.changed == 'true'
        uses: actions/checkout@v4

      - name: Setup .NET
        if: matrix.function-config.changed == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Azure Login via OIDC
        if: matrix.function-config.changed == 'true'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build Function App
        if: matrix.function-config.changed == 'true'
        run: |
          cd ${{ matrix.function-config.path }}/${{ matrix.function-config.path }}
          echo "üî® Building ${{ matrix.function-config.name }} for production..."
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet publish --configuration Release --output ./publish --no-build

      - name: Create deployment package
        if: matrix.function-config.changed == 'true'
        run: |
          cd ${{ matrix.function-config.path }}/${{ matrix.function-config.path }}/publish
          zip -r ../../../${{ matrix.function-config.name }}-production-package.zip .
          echo "üì¶ Production package created: ${{ matrix.function-config.name }}-production-package.zip"

      - name: Get production environments for this function
        if: matrix.function-config.changed == 'true'
        id: get-environments
        run: |
          # Read configuration and extract production environments that use this function
          environments=$(cat config/clients-sqlserver.json | jq -r --arg func "${{ matrix.function-config.name }}" '
            .clients | to_entries[] | 
            select(.value.environments.main.functions.core[]? == $func or 
                   .value.environments.main.functions.plugins[]? == $func) |
            .key
          ' | jq -R -s -c 'split("\n")[:-1]')
          echo "environments=$environments" >> $GITHUB_OUTPUT
          echo "üéØ Will deploy ${{ matrix.function-config.name }} to production environments: $environments"

      - name: Deploy to production environments
        if: matrix.function-config.changed == 'true'
        run: |
          environments='${{ steps.get-environments.outputs.environments }}'
          
          if [ "$environments" = "[]" ] || [ -z "$environments" ]; then
            echo "‚è≠Ô∏è  No production environments found for ${{ matrix.function-config.name }}"
            exit 0
          fi
          
          echo "üöÄ Deploying ${{ matrix.function-config.name }} to ALL production environments..."
          echo "üìã This PR contained changes to ${{ matrix.function-config.name }}, deploying to:"
          
          for client in $(echo $environments | jq -r '.[]'); do
            echo "   üì¶ $client-main"
          done
          
          for client in $(echo $environments | jq -r '.[]'); do
            echo ""
            echo "üöÄ Deploying ${{ matrix.function-config.name }} to $client-main..."
            
            # Get function app name for this client
            function_app_name="${{ matrix.function-config.name }}-${client}-main"
            resource_group="rg-witag-${client}-main"
            
            echo "   üì¶ Function App: $function_app_name"
            echo "   üìã Resource Group: $resource_group"
            
            # Deploy using Azure CLI
            az functionapp deployment source config-zip \
              --resource-group "$resource_group" \
              --name "$function_app_name" \
              --src "${{ matrix.function-config.name }}-production-package.zip" \
              --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}"
            
            if [ $? -eq 0 ]; then
              echo "   ‚úÖ Successfully deployed to $function_app_name"
            else
              echo "   ‚ùå Failed to deploy to $function_app_name"
              exit 1
            fi
          done

      - name: Verify production deployments
        if: matrix.function-config.changed == 'true'
        run: |
          environments='${{ steps.get-environments.outputs.environments }}'
          
          if [ "$environments" = "[]" ] || [ -z "$environments" ]; then
            echo "‚è≠Ô∏è  No production environments to verify"
            exit 0
          fi
          
          echo "üîç Verifying all production deployments..."
          
          for client in $(echo $environments | jq -r '.[]'); do
            function_app_name="${{ matrix.function-config.name }}-${client}-main"
            resource_group="rg-witag-${client}-main"
            
            echo "üîç Verifying $function_app_name..."
            
            # Check if function app is running
            status=$(az functionapp show \
              --resource-group "$resource_group" \
              --name "$function_app_name" \
              --query "state" \
              --output tsv \
              --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}")
            
            if [ "$status" = "Running" ]; then
              echo "   ‚úÖ $function_app_name is running successfully"
            else
              echo "   ‚ö†Ô∏è  $function_app_name status: $status"
            fi
            
            # Get function app URL for quick check
            hostname=$(az functionapp show \
              --resource-group "$resource_group" \
              --name "$function_app_name" \
              --query "defaultHostName" \
              --output tsv \
              --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}")
            
            echo "   üåê Function App URL: https://$hostname"
          done

      - name: Deployment Summary
        if: matrix.function-config.changed == 'true'
        run: |
          environments='${{ steps.get-environments.outputs.environments }}'
          
          echo ""
          echo "üìä PRODUCTION DEPLOYMENT SUMMARY"
          echo "================================="
          echo "üîß Function: ${{ matrix.function-config.name }}"
          echo "üìã PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo ""
          echo "üéØ Deployed to production environments:"
          
          for client in $(echo $environments | jq -r '.[]'); do
            function_app_name="${{ matrix.function-config.name }}-${client}-main"
            echo "   ‚úÖ $function_app_name"
          done
          
          echo ""
          echo "üéâ All production deployments completed successfully!"

  notify-completion:
    needs: [detect-changes, deploy-functions]
    if: always() && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy-functions.result }}" = "success" ]; then
            echo "üéâ Production functions deployment completed successfully!"
            echo "üìã PR #${{ github.event.pull_request.number }} changes have been deployed to all production environments"
          elif [ "${{ needs.deploy-functions.result }}" = "failure" ]; then
            echo "‚ùå Production functions deployment failed!"
            echo "üìã PR #${{ github.event.pull_request.number }} changes could not be deployed"
            exit 1
          elif [ "${{ needs.deploy-functions.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è  No function changes detected in PR #${{ github.event.pull_request.number }}"
          fi 