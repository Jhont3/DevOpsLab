name: Deploy Infrastructure

on:
  push:
    branches: [ main, testing ]
    paths:
      - 'config/clients.json'
      - 'infrastructure/**'
  workflow_dispatch:
    inputs:
      client_name:
        description: 'Client name to deploy'
        required: true
        type: string
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - testing
          - main
          - both
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        type: boolean
        default: false

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      config-changed: ${{ steps.changes.outputs.config }}
      infrastructure-changed: ${{ steps.changes.outputs.infrastructure }}
      clients-to-deploy: ${{ steps.get-clients.outputs.clients }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            config:
              - 'config/clients.json'
            infrastructure:
              - 'infrastructure/**'
      
      - name: Get clients to deploy
        id: get-clients
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - deploy specific client
            client_name="${{ github.event.inputs.client_name }}"
            environment="${{ github.event.inputs.environment }}"
            
            # Create proper JSON array
            clients_json="[\"$client_name\"]"
            echo "clients=$clients_json" >> $GITHUB_OUTPUT
          else
            # Automatic trigger - deploy all clients
            clients_json=$(cat config/clients.json | jq -c '.clients | keys')
            echo "clients=$clients_json" >> $GITHUB_OUTPUT
          fi

  deploy-infrastructure:
    needs: detect-changes
    if: needs.detect-changes.outputs.config-changed == 'true' || needs.detect-changes.outputs.infrastructure-changed == 'true' || github.event.inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client: ${{ fromJson(needs.detect-changes.outputs.clients-to-deploy) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell
        run: |
          # Install PowerShell
          wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure CLI Bicep extension
        run: az bicep install

      - name: Configure Azure CLI defaults
        run: |
          # Configure Azure CLI defaults to avoid caching issues that cause "content consumed" error
          az configure --defaults location="East US"
          echo "Azure CLI defaults configured"

      - name: Validate Bicep template
        run: |
          echo "‚úÖ Validating Bicep template..."
          
          # Use bicep build to validate syntax first (safer than az validate)
          bicep build infrastructure/bicep/main.bicep --stdout > /dev/null
          
          # Also validate modules individually
          bicep build infrastructure/bicep/modules/appserviceplan.bicep --stdout > /dev/null
          bicep build infrastructure/bicep/modules/cosmosdb.bicep --stdout > /dev/null
          bicep build infrastructure/bicep/modules/functionapp.bicep --stdout > /dev/null
          bicep build infrastructure/bicep/modules/storage.bicep --stdout > /dev/null
          
          echo "‚úÖ Bicep syntax validation completed"

      - name: Deploy testing environment
        if: github.ref == 'refs/heads/testing' || github.event.inputs.environment == 'testing' || github.event.inputs.environment == 'both'
        run: |
          pwsh -File scripts/Deploy-Environment.ps1 \
            -ClientName "${{ matrix.client }}" \
            -Environment "testing" \
            -SubscriptionId "${{ env.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy production environment
        if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'main' || github.event.inputs.environment == 'both'
        run: |
          pwsh -File scripts/Deploy-Environment.ps1 \
            -ClientName "${{ matrix.client }}" \
            -Environment "main" \
            -SubscriptionId "${{ env.AZURE_SUBSCRIPTION_ID }}"

      - name: Wait for resources to be ready
        if: github.ref == 'refs/heads/testing' || github.ref == 'refs/heads/main' || github.event.inputs.environment != ''
        run: |
          echo "‚è≥ Waiting for resources to be fully provisioned..."
          sleep 30

      - name: Initialize database with sample data
        if: github.ref == 'refs/heads/testing' || github.ref == 'refs/heads/main' || github.event.inputs.environment != ''
        run: |
          # Determine environment based on branch or input
          if [ "${{ github.ref }}" = "refs/heads/testing" ] || [ "${{ github.event.inputs.environment }}" = "testing" ]; then
            ENVIRONMENT="testing"
          else
            ENVIRONMENT="main"
          fi
          
          echo "üóÉÔ∏è Initializing database for ${{ matrix.client }} in $ENVIRONMENT environment..."
          
          pwsh -File scripts/Initialize-Database.ps1 \
            -ClientName "${{ matrix.client }}" \
            -Environment "$ENVIRONMENT" \
            -ConfigPath "config/clients.json"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment for client: ${{ matrix.client }}"
          
          # Determine environment
          if [ "${{ github.ref }}" = "refs/heads/testing" ] || [ "${{ github.event.inputs.environment }}" = "testing" ]; then
            ENVIRONMENT="testing"
          else
            ENVIRONMENT="main"
          fi
          
          echo "Checking $ENVIRONMENT environment..."
          
          # Get resource group from config
          rg_name=$(cat config/clients.json | jq -r ".clients.${{ matrix.client }}.environments.$ENVIRONMENT.resourceGroup")
          cosmos_name=$(cat config/clients.json | jq -r ".clients.${{ matrix.client }}.environments.$ENVIRONMENT.cosmosDb.accountName")
          
          echo "üìã Expected resources:"
          echo "   - Resource Group: $rg_name"
          echo "   - Cosmos DB: $cosmos_name"
          
          # Check if resource group exists
          if az group show --name "$rg_name" --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" > /dev/null 2>&1; then
            echo "‚úÖ Resource group $rg_name exists"
            
            # List resources in the group
            echo "üì¶ Resources created:"
            az resource list --resource-group "$rg_name" --query "[].{Name:name, Type:type}" --output table
            
            # Check Cosmos DB specifically
            if az cosmosdb show --name "$cosmos_name" --resource-group "$rg_name" --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" > /dev/null 2>&1; then
              echo "‚úÖ Cosmos DB $cosmos_name is accessible"
              
              # Check collections
              echo "üìä Cosmos DB collections:"
              az cosmosdb sql container list --account-name "$cosmos_name" --database-name "witag-db" --resource-group "$rg_name" --query "[].id" --output table 2>/dev/null || echo "   Collections will be available shortly..."
            else
              echo "‚ö†Ô∏è  Cosmos DB $cosmos_name not yet fully available"
            fi
          else
            echo "‚ùå Resource group $rg_name does not exist"
            exit 1
          fi

  notify-completion:
    needs: [detect-changes, deploy-infrastructure]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy-infrastructure.result }}" = "success" ]; then
            echo "üéâ Infrastructure deployment completed successfully!"
          elif [ "${{ needs.deploy-infrastructure.result }}" = "failure" ]; then
            echo "‚ùå Infrastructure deployment failed!"
            exit 1
          elif [ "${{ needs.deploy-infrastructure.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è  No infrastructure changes detected, skipping deployment"
          fi 