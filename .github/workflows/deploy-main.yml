name: Deploy Infrastructure - Main

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      client_name:
        description: 'Client name to deploy'
        required: true
        default: 'elite'
        type: choice
        options:
          - elite
          - jarandes
      force_deploy:
        description: 'Force deployment even if resources exist'
        required: false
        default: false
        type: boolean

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  DEFAULT_LOCATION: "Australia East"

jobs:
  validate-templates:
    name: ğŸ” Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install Bicep
        run: az bicep install

      - name: Validate Main Template
        run: |
          echo "ğŸ” Validating main Bicep template..."
          az bicep build --file infrastructure/bicep/main.bicep
          echo "âœ… Main template validation passed"

      - name: Validate Cosmos DB Template
        run: |
          echo "ğŸ” Validating Cosmos DB template..."
          az bicep build --file infrastructure/bicep/modules/cosmosdb.bicep
          echo "âœ… Cosmos DB template validation passed"

      - name: Validate Storage Template
        run: |
          echo "ğŸ” Validating Storage template..."
          az bicep build --file infrastructure/bicep/modules/storage.bicep
          echo "âœ… Storage template validation passed"

  deploy-elite-main:
    name: ğŸš€ Deploy Elite Main Environment
    runs-on: ubuntu-latest
    needs: validate-templates
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
          echo "âœ… Azure subscription set"

      - name: Deploy Infrastructure
        run: |
          echo "ğŸš€ Starting deployment for elite-main..."
          pwsh -File scripts/Deploy-Environment.ps1 \
            -ClientName "elite" \
            -Environment "main" \
            -SubscriptionId "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            -Location "${{ env.DEFAULT_LOCATION }}"
          echo "âœ… Infrastructure deployment completed"

      - name: Wait for Resources to be Ready
        run: |
          echo "â³ Waiting for resources to be fully ready..."
          sleep 60
          echo "âœ… Wait completed"

      - name: Initialize Cosmos DB Data
        run: |
          echo "ğŸ“‹ Initializing Cosmos DB with default data..."
          pwsh -File scripts/Initialize-CosmosData.ps1 \
            -ClientName "elite" \
            -Environment "main"
          echo "âœ… Data initialization completed"

      - name: Validate Cosmos DB Data
        run: |
          echo "ğŸ” Validating Cosmos DB data..."
          pwsh -File scripts/Validate-CosmosData.ps1 \
            -ClientName "elite" \
            -Environment "main"
          echo "âœ… Data validation completed"

      - name: Get Deployment Summary
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "   ğŸ¢ Client: elite"
          echo "   ğŸŒ Environment: main"
          echo "   ğŸ“ Location: ${{ env.DEFAULT_LOCATION }}"
          echo "   ğŸ†” Subscription: ${{ env.AZURE_SUBSCRIPTION_ID }}"
          echo "   ğŸ“… Deployed at: $(date)"
          
          # Get resource group info
          rg_name="rg-witag-elite-main"
          echo "   ğŸ“¦ Resource Group: $rg_name"
          
          # List created resources
          echo "ğŸ”— Created Resources:"
          az resource list --resource-group $rg_name --output table || true

  deploy-jarandes-main:
    name: ğŸš€ Deploy Jarandes Main Environment
    runs-on: ubuntu-latest
    needs: validate-templates
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
          echo "âœ… Azure subscription set"

      - name: Deploy Infrastructure
        run: |
          echo "ğŸš€ Starting deployment for jarandes-main..."
          pwsh -File scripts/Deploy-Environment.ps1 \
            -ClientName "jarandes" \
            -Environment "main" \
            -SubscriptionId "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            -Location "${{ env.DEFAULT_LOCATION }}"
          echo "âœ… Infrastructure deployment completed"

      - name: Wait for Resources to be Ready
        run: |
          echo "â³ Waiting for resources to be fully ready..."
          sleep 60
          echo "âœ… Wait completed"

      - name: Initialize Cosmos DB Data
        run: |
          echo "ğŸ“‹ Initializing Cosmos DB with default data..."
          pwsh -File scripts/Initialize-CosmosData.ps1 \
            -ClientName "jarandes" \
            -Environment "main"
          echo "âœ… Data initialization completed"

      - name: Validate Cosmos DB Data
        run: |
          echo "ğŸ” Validating Cosmos DB data..."
          pwsh -File scripts/Validate-CosmosData.ps1 \
            -ClientName "jarandes" \
            -Environment "main"
          echo "âœ… Data validation completed"

      - name: Get Deployment Summary
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "   ğŸ¢ Client: jarandes"
          echo "   ğŸŒ Environment: main"
          echo "   ğŸ“ Location: ${{ env.DEFAULT_LOCATION }}"
          echo "   ğŸ†” Subscription: ${{ env.AZURE_SUBSCRIPTION_ID }}"
          echo "   ğŸ“… Deployed at: $(date)"
          
          # Get resource group info
          rg_name="rg-witag-jarandes-main"
          echo "   ğŸ“¦ Resource Group: $rg_name"
          
          # List created resources
          echo "ğŸ”— Created Resources:"
          az resource list --resource-group $rg_name --output table || true

  manual-deploy:
    name: ğŸ¯ Manual Deploy (Workflow Dispatch)
    runs-on: ubuntu-latest
    needs: validate-templates
    if: github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
          echo "âœ… Azure subscription set"

      - name: Deploy Infrastructure
        run: |
          echo "ğŸš€ Starting manual deployment for ${{ github.event.inputs.client_name }}-main..."
          pwsh -File scripts/Deploy-Environment.ps1 \
            -ClientName "${{ github.event.inputs.client_name }}" \
            -Environment "main" \
            -SubscriptionId "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            -Location "${{ env.DEFAULT_LOCATION }}"
          echo "âœ… Infrastructure deployment completed"

      - name: Wait for Resources to be Ready
        run: |
          echo "â³ Waiting for resources to be fully ready..."
          sleep 60
          echo "âœ… Wait completed"

      - name: Initialize Cosmos DB Data
        run: |
          echo "ğŸ“‹ Initializing Cosmos DB with default data..."
          pwsh -File scripts/Initialize-CosmosData.ps1 \
            -ClientName "${{ github.event.inputs.client_name }}" \
            -Environment "main"
          echo "âœ… Data initialization completed"

      - name: Validate Cosmos DB Data
        run: |
          echo "ğŸ” Validating Cosmos DB data..."
          pwsh -File scripts/Validate-CosmosData.ps1 \
            -ClientName "${{ github.event.inputs.client_name }}" \
            -Environment "main"
          echo "âœ… Data validation completed"

      - name: Get Deployment Summary
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "   ğŸ¢ Client: ${{ github.event.inputs.client_name }}"
          echo "   ğŸŒ Environment: main"
          echo "   ğŸ“ Location: ${{ env.DEFAULT_LOCATION }}"
          echo "   ğŸ†” Subscription: ${{ env.AZURE_SUBSCRIPTION_ID }}"
          echo "   ğŸ“… Deployed at: $(date)"
          echo "   ğŸ”„ Force Deploy: ${{ github.event.inputs.force_deploy }}"
          
          # Get resource group info
          rg_name="rg-witag-${{ github.event.inputs.client_name }}-main"
          echo "   ğŸ“¦ Resource Group: $rg_name"
          
          # List created resources
          echo "ğŸ”— Created Resources:"
          az resource list --resource-group $rg_name --output table || true
